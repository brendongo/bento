steps:
  - name: init
    description: initialize a git repo
    command:
      - bash
      - -c
      - git init && git config user.email test@r2c.dev && git config user.name Test
  - name: base commit
    description: create a root git commit
    command:
      - bash
      - -c
      - echo "x = y" > foo.py && git add foo.py && git commit -m base && git checkout -b master
  - name: create branch
    description: create test branch
    command: git branch test-a
  - name: bento register
    description: fake bento registration
    command:
      - bash
      - -c
      - 'if [[ ! -e ~/.bento/config.yml ]]; then mkdir -p ~/.bento && echo -e "email: test@r2c.dev\nterms_of_service: 0.3.0" > ~/.bento/config.yml; fi'
  - name: bento init
    description: initialize bento
    command: bento --agree init
    returncode: 0
    expected_out: null
    expected_err: bento-init.err
  #
  # CHANGES TO INDEX ONLY
  #
  # Staged addition, no diffs
  # fails check, fails commit
  - name: stage add
    description: stage a new file with findings
    command:
      - bash
      - -c
      - echo "y = z" > bar.py && git add bar.py
  - name: check stage add
    description: bento check with a new file with findings
    command: bento check
    returncode: 2
    expected_out: check-stage-add.out
    expected_err: check-stage-add.err
  - name: commit stage add
    description: attempt to commit a new file with findings
    command: git commit -m foo
    returncode: 1
    expected_out: null
    expected_err: commit-stage-add.err
  - name: status stage add
    description: ensure git status shows added file
    command: git status --porcelain -uno
    returncode: 0
    expected_out: status-stage-add.out
  - name: reset stage add
    description: restore git index
    command: git reset --hard
  #
  # Staged modification, no diffs
  # fails check, fails commit
  - name: stage modify
    description: modify file
    command:
      - bash
      - -c
      - echo "x = z" > foo.py && git add foo.py
  - name: check stage modify
    description: bento check with a modified file with findings
    command: bento check
    returncode: 2
    expected_out: check-stage-modify.out
    expected_err: check-stage-modify.err
  - name: commit stage modify
    description: attempt to commit a modified file with findings
    command: git commit -m foo
    returncode: 1
    expected_out: null
    expected_err: commit-stage-modify.err
  - name: status stage modify
    description: ensure git status shows modified file
    command: git status --porcelain -uno
    returncode: 0
    expected_out: status-stage-modify.out
  - name: reset stage modify
    description: restore git index
    command: git reset --hard
    #
    # Staged deletion, no diffs
    # passes check, passes commit
  - name: stage delete
    description: delete file
    command: git rm foo.py
  - name: check stage delete
    description: bento check with a deleted file with findings
    command: bento check
    returncode: 0
    expected_out: null
    expected_err: check-stage-delete.err
  - name: status stage delete
    description: ensure git status shows deleted file
    command: git status --porcelain -uno
    returncode: 0
    expected_out: status-stage-delete.out
  - name: commit stage delete
    description: attempt to commit a deletion with findings
    command: git commit -m foo
    returncode: 0
    expected_err: commit-stage-delete.err
    expected_out: commit-stage-delete.out
  - name: reset stage delete
    description: restore git index
    command: git reset --hard master
